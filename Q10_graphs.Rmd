---
title: "Q10_graphs"
author: "Sarah Goldsmith"
date: "4/8/2022"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

````{r message = FALSE}
library(plyr)
library(ggplot2)
library(dplyr)
library(ggmap)
library(stringr)
library(sf)
library(mapview)
library(ggcorrplot)
library(PerformanceAnalytics)
library(lme4)
library(nlme)
library(MuMIn)
library(lmerTest)
#library(maps)
```

#set working directory
```{r}
#setwd("/Users/sarahgoldsmith/Documents/Dartmouth/Q10_review")

setwd("~/Documents/GitHub/Q10_review")

```

#read in file
```{r}
alldata <- read.csv("Q10_alldata_workingfile2.csv")
```

#Unit conversions
```{r}
#make sure columns that are supposed to be numeric are actually numeric
alldata <- alldata %>% 
  mutate_at(vars(MAP, MAT, latitude1, longitude1, activeLayer, topDepth, bottomDepth, SOC, nitrogenMean, cn, bulkDensityMean,  replicates, pH, redox, percentSand, percentSilt, percentClay, microbialBiomass, Q10, minTemp, maxTemp, duration), ~as.numeric(as.character(.))) 

# unit conversions
unique(alldata$carbonUnits)
#convert units to percent
alldata$carbonPercent <- as.numeric(ifelse(alldata$carbonUnits == "percent", alldata$carbonMean, ifelse(
  alldata$carbonUnits == "mg g-1" | alldata$carbonUnits == "g kg-1", alldata$carbonMean /10, ""
)))
# "Aaltonen2019JEM" reports in "kg m-2", but no BD available

unique(alldata$SOCUnits)
alldata$SOCpercent <- as.numeric(ifelse(alldata$SOCUnits == "percent", alldata$SOC, ifelse(alldata$SOCUnits == "SOC (g kg-1)" | alldata$SOCUnits == "g kg -1", alldata$SOC /10, ifelse(alldata$SOCUnits == "g 100 g-1 soil", alldata$SOC *100, ""))))

#merge SOC and %C
alldata$carbonPercentAll <- ifelse(!is.na(alldata$SOCpercent), alldata$SOCpercent, alldata$carbonPercent)

unique(alldata$nitrogenUnits)
alldata$nitrogenPercent <- as.numeric (ifelse(alldata$nitrogenUnits == "percent", alldata$nitrogenMean, ifelse(
  alldata$nitrogenUnits == "mg/gSoil" | alldata$nitrogenUnits =="g kg-1", alldata$nitrogenMean /10, ifelse( alldata$nitrogenUnits == "g 100g-1 soil", alldata$nitrogenMean *100, ""
))))

unique(alldata$microbialBiomassUnits)
#convert to mg/kg?
alldata$microbialBiomass2 <- as.numeric (ifelse(alldata$microbialBiomassUnits == "mg kg-1", alldata$microbialBiomass, ifelse(alldata$microbialBiomassUnits == "ug C g soil-1" | alldata$microbialBiomassUnits == "microg/gSoil", alldata$microbialBiomass /1000, ifelse(alldata$microbialBiomassUnits == "mg g-1", alldata$microbialBiomass *1000, ""
))))


#calculate duration in... days??
alldata$durationDays <- as.numeric(ifelse(alldata$durationUnits == "days", alldata$duration, ifelse(alldata$durationUnits == "hr", alldata$duration /24, ifelse(alldata$durationUnits == "year", alldata$duration *365, ifelse(alldata$durationUnits == "weeks", alldata$duration /7, "")))))


#calculate temperature range
alldata$tempRange <- as.numeric(alldata$maxTemp - alldata$minTemp)

#categorize midDepth into categories? 0-10, 10-30, 30-50, 50-end 
alldata$depthCategory <- ifelse(alldata$midDepth <= 10, "0-10", ifelse(alldata$midDepth >10 & alldata$midDepth <= 30, "10-30", ifelse(alldata$midDepth >30 & alldata$midDepth <= 50, "30-50", "50-end")))

alldata$uniqueSite <- paste(alldata$citationKey, alldata$site)
alldata$uniqueID <- paste(alldata$site, alldata$midDepth)
```
#Information about the data 
```{r}
#number of unique studies
length(unique(alldata$citationKey))
# number of papers from/not from review papers
print("number of papers")
length(unique(alldata[which(is.na(alldata$reviewPaperKey)),1]))
length(unique(alldata[which(alldata$reviewPaperKey == "Li2020AdvSci"),1]))
length(unique(alldata[which(alldata$reviewPaperKey == "Ren2020GBC"),1]))

# number of data points from/not from review papers
print("number of data points")
length(alldata[which(is.na(alldata$reviewPaperKey)),1])
length(alldata[which(alldata$reviewPaperKey == "Li2020AdvSci"),1])
length(alldata[which(alldata$reviewPaperKey == "Ren2020GBC"),1])


```

#Exploratory graphs
```{r warning=FALSE}

#histogram of Q10 values
ggplot(alldata) + geom_histogram(aes(Q10))

# depth plots
ggplot(alldata) + geom_histogram(aes(midDepth))

ggplot(alldata) + geom_point(aes(y = midDepth, x = Q10))
```

```{r warning=FALSE}
#duration plots
ggplot(alldata) + geom_histogram(aes(durationDays))

ggplot(alldata) + geom_point(aes(x = durationDays, y = Q10)) 
```

```{r warning=FALSE}
#plot Q10 vs % carbon 

ggplot() + geom_point(data = alldata, aes(x = carbonPercentAll, y = Q10))
ggplot() + geom_point(data = alldata, aes(x = SOCpercent, y = Q10))

ggplot(alldata) + geom_point(aes(x = cn, y = Q10))

```

```{r}
###### map study locations #####
worldmap <- map_data(map = "world")
ggplot() + geom_point(data = alldata, aes(x = longitude1, y = latitude1), color = "black", size = 1) + geom_polygon(data = worldmap, aes(x=long, y = lat, group = group)) + geom_point(data = alldata, aes(x = longitude1, y = latitude1), color = "yellow", size = 0.5)

#number of countries represented 
unique(alldata$country)
length(unique(alldata$country))

ggplot(alldata) + geom_bar(aes(country)) #this might not be the most useful. But most of the data is from China

```

```{r warning=FALSE}
#climate variables (temperature, elevation)
ggplot(alldata) + geom_point(aes(x = MAP, y = Q10))
ggplot(alldata) + geom_point(aes(x = MAT, y = Q10))

#sand/silt/clay
ggplot(alldata) + geom_point(aes(x = percentSand, y = Q10))
ggplot(alldata) + geom_point(aes(x = percentSilt, y = Q10))
ggplot(alldata) + geom_point(aes(x = percentClay, y = Q10))
```

```{r warning=FALSE} 
# incubation temperature 
ggplot(data = alldata) + geom_point(aes(x = maxTemp, y = Q10))
ggplot(data = alldata) + geom_point(aes(x = minTemp, y = Q10))
ggplot(data = alldata) + geom_point(aes(x = tempRange, y = Q10))

```


```{r warning=FALSE}
#make facet graphs
ggplot(data = alldata, aes(Q10, midDepth, color = citationKey)) + geom_point(show.legend = FALSE) + facet_wrap(~landCover)
#ggsave(filename = "Q10 by landcover.png")

ggplot(data = alldata, aes(Q10, midDepth, color = citationKey)) + geom_point(show.legend = FALSE) + facet_wrap(~soilOrder)

#correlation plots
alldata.climate <- alldata %>%
  select(MAT, MAP, midDepth, pH, cn, Q10, carbonPercentAll, nitrogenPercent, microbialBiomass2)
chart.Correlation(alldata.climate, pch = 19)

alldata.incubation <- alldata %>%
  select(Q10,minTemp, maxTemp, tempRange, durationDays)
chart.Correlation(alldata.incubation)

```

```{r warning=FALSE}
#facet graphs by depth category

ggplot(data = alldata, aes(tempRange, Q10)) + 
  geom_point() + 
  geom_smooth() + 
  facet_wrap(~depthCategory)

ggplot(data = alldata, aes(minTemp, Q10)) + 
  geom_point() + 
  geom_smooth() + 
  facet_wrap(~depthCategory)

ggplot(data = alldata, aes(durationDays, Q10)) + 
  geom_point() + 
  facet_wrap(~depthCategory)

ggplot(data = alldata, aes(Q10, carbonPercentAll, color = citationKey)) + geom_point(show.legend = FALSE) + facet_wrap(~depthCategory)
ggplot(data = alldata, aes(Q10, cn, color = citationKey)) + geom_point(show.legend = FALSE) + facet_wrap(~depthCategory)
ggplot(data = alldata, aes(Q10, nitrogenPercent, color = citationKey)) + geom_point(show.legend = FALSE) + facet_wrap(~depthCategory)
ggplot(data = alldata, aes(Q10, microbialBiomass2, color = citationKey)) + geom_point(show.legend = FALSE) + facet_wrap(~depthCategory)

```

#Build Models
#Experiment characteristics model
```{r}
#look for optimal random effects
mod<-gls(data=alldata, Q10~ 1+ minTemp + durationDays, na.action = na.omit)
mod2<-lmer(data=alldata, Q10~1+ minTemp + durationDays + (1|uniqueSite), na.action = na.omit)
mod3<-lmer(data=alldata, Q10~1+ minTemp + durationDays + (1|citationKey), na.action = na.omit)
mod4<-lmer(data=alldata, Q10~1+ minTemp + durationDays + (1|citationKey/uniqueSite), na.action = na.omit)
AICc(mod, mod2, mod3, mod4)

summary(mod4)
anova(mod4)

#graphical exploration of residuals
F_Final <- fitted(mod4)
R_Final <- residuals(mod4, type = "pearson", scaled = TRUE) #type="response" 

N = !is.na(alldata$durationDays)
Rfull <- NA
Rfull[N] <- R_Final

op <- par(mfrow = c(2,2), mar = c(5,4,1,1))
plot(F_Final, R_Final) #variance increases with value of Q10
hist(Rfull)
plot(Rfull ~ alldata$minTemp)
plot(Rfull ~ alldata$durationDays)
plot(Rfull ~ alldata$minTemp)
plot(Rfull ~ alldata$maxTemp)
par(op)

#transform response variable
alldata$Q10T<-log(alldata$Q10)

#look for optimal random effects
mod<-gls(data=alldata, Q10T~ 1+ minTemp*midDepth + durationDays*midDepth, na.action = na.omit)
mod2<-lmer(data=alldata, Q10T~1+ minTemp*midDepth + durationDays*midDepth + (1|uniqueSite), na.action = na.omit)
mod3<-lmer(data=alldata, Q10T~1+ minTemp*midDepth + durationDays*midDepth + (1|citationKey), na.action = na.omit)
mod4<-lmer(data=alldata, Q10T~1+ minTemp*midDepth + durationDays*midDepth + (1|citationKey/uniqueSite), na.action = na.omit)
AIC(mod, mod2, mod3, mod4)

summary(mod4)
anova(mod4)

F_Final <- fitted(mod4)
R_Final <- residuals(mod4, type = "pearson", scaled = TRUE) #type="response" 


N = !is.na(alldata$durationDays)
Rfull <- NA
Rfull[N] <- R_Final

op <- par(mfrow = c(2,2), mar = c(5,4,1,1))
plot(F_Final, R_Final) #variance increases with value of Q10
hist(Rfull)
plot(Rfull ~ alldata$minTemp)
plot(Rfull ~ alldata$durationDays)
plot(Rfull ~ alldata$minTemp)
plot(Rfull ~ alldata$maxTemp)
par(op)


```
#View the trends
```{r}
library(emmeans)

emmip(mod4, Q10T ~ durationDays|midDepth, cov.reduce=range)

emtrends(mod4, ~1, var="durationDays")

mylist <- list(midDepth=c(5,15,30,50, 100))

emmip(mod4,~midDepth*durationDays,at=mylist, CIs=TRUE)

dura <- mean(alldata$durationDays, na.rm=T) + sd(alldata$durationDays, na.rm=T)
dur <- mean(alldata$durationDays, na.rm=T)
durb <- mean(alldata$durationDays, na.rm=T) - sd(alldata$durationDays, na.rm=T)

alldata[which(is.na(alldata$Q10)),]



```



#Environmental Characteristics (no carbon) Model
```{r}
print("number of data points with all variables (environmental model: midDepth, landCover, nitrogen, MAP)")
length(which(!is.na(alldata$midDepth) & !is.na(alldata$landCover) & !is.na(alldata$nitrogenPercent) & !is.na(alldata$MAP)))
print("number of data points with all variables AND %carbon")
length(which(!is.na(alldata$midDepth) & !is.na(alldata$landCover) & !is.na(alldata$nitrogenPercent) & !is.na(alldata$MAP) & !is.na(alldata$carbonPercent)))

#look for optimal random effects using transformed Q10
mod <- gls(data=alldata, Q10T ~ 1 + midDepth*landCover + nitrogenPercent*midDepth + MAP*midDepth, na.action = na.omit)
mod2 <- lmer(data=alldata, Q10T ~ 1 + midDepth*landCover + nitrogenPercent*midDepth + MAP*midDepth + (1|uniqueSite), na.action = na.omit)
mod3 <- lmer(data=alldata, Q10T ~ 1 + midDepth*landCover + nitrogenPercent*midDepth + MAP*midDepth + (1|citationKey), na.action = na.omit)
mod4 <- lmer(data=alldata,Q10T ~ 1 + midDepth*landCover + nitrogenPercent*midDepth + MAP*midDepth + (1|citationKey/uniqueSite), na.action = na.omit)
#Some predictor variables are on very different scales: consider rescaling (models 2-4)

AICc(mod, mod2, mod3, mod4)
#lowest AICc = mod4

summary(mod4)
anova(mod4)

#graphical exploration of residuals
F_Final <- fitted(mod4)
R_Final <- residuals(mod4, type = "pearson", scaled = TRUE) #type="response" 
#no difference in graphs with pearson vs response

N = !is.na(alldata$Q10)
Rfull <- NA
Rfull[N] <- R_Final

op <- par(mfrow = c(2,2), mar = c(5,4,1,1))
plot(F_Final, R_Final) #variance increases with value of Q10
hist(Rfull)
plot(Rfull ~ alldata$midDepth)
plot(Rfull ~ alldata$nitrogenPercent) #decrease in variance with N?
plot(Rfull ~ alldata$MAP)
par(op)

#Model Selection
#choose data with only complete cases so can compare as drop variables
alldata_envN <- alldata %>%
  filter(complete.cases(landCover,nitrogenPercent, MAP))

mod4 <- lmer(data=alldata_envN,Q10T ~ 1 + midDepth*landCover + nitrogenPercent*midDepth + MAP*midDepth + (1|citationKey/uniqueSite), na.action = na.omit, REML=FALSE)

mod4a <- lmer(data=alldata_envN,Q10T ~ 1 + midDepth*landCover + nitrogenPercent*midDepth + MAP + (1|citationKey/uniqueSite), na.action = na.omit, REML=FALSE)
AIC(mod4, mod4a)
anova(mod4a) #highest p is MAP, so take it away for next model

mod4b <- lmer(data=alldata_envN,Q10T ~ 1 + midDepth*landCover + nitrogenPercent*midDepth + (1|citationKey/uniqueSite), na.action = na.omit, REML=FALSE)
AIC(mod4a, mod4b) #slightly greater AIC
anova(mod4a, mod4b) #no diff so not needed 
anova(mod4b)

mod4c <- lmer(data=alldata_envN,Q10T ~ 1 + midDepth+landCover + nitrogenPercent*midDepth + (1|citationKey/uniqueSite), na.action = na.omit, REML=FALSE)
AIC(mod4b, mod4c) #4c is slightly worse
anova(mod4b, mod4c) #and there is a sig difference

mod4d <- lmer(data=alldata_envN,Q10T ~ 1 + midDepth*landCover + nitrogenPercent+midDepth + (1|citationKey/uniqueSite), na.action = na.omit, REML=FALSE)
AIC(mod4b, mod4d) #4d is  worse
anova(mod4b, mod4c) #and there is a sig difference

#So cannot drop main effects if interactions are significant. Rerun best model with REML

mod_final <- lmer(data=alldata_envN,Q10T ~ 1 + midDepth*landCover + nitrogenPercent*midDepth + (1|citationKey/uniqueSite), na.action = na.omit, REML=TRUE)

anova(mod_final)

#graphical exploration of residuals
F_Final <- fitted(mod_final)
R_Final <- residuals(mod_final, type = "pearson", scaled = TRUE) #type="response" 
#no difference in graphs with pearson vs response

N = !is.na(alldata_envN$Q10)
Rfull <- NA
Rfull[N] <- R_Final

op <- par(mfrow = c(2,2), mar = c(5,4,1,1))
plot(F_Final, R_Final) #variance increases with value of Q10
hist(Rfull)
plot(Rfull ~ alldata_envN$midDepth)
plot(Rfull ~ alldata_envN$nitrogenPercent) #decrease in variance with N?
plot(Rfull ~ alldata_envN$MAP)
boxplot(Rfull~alldata_envN$landCover)
par(op)


```
#Only landCover
```{r}
print("number of data points with all variables (environmental model: midDepth, landCover, nitrogen, MAP)")
length(which(!is.na(alldata$midDepth) & !is.na(alldata$landCover) & !is.na(alldata$nitrogenPercent) & !is.na(alldata$MAP)))
print("number of data points with land cover")
length(which(!is.na(alldata$midDepth) & !is.na(alldata$landCover)))

#look for optimal random effects using transformed Q10 
#should carbon be included as carbon x depth? 
mod <- gls(data=alldata, Q10T ~ 1 + midDepth*landCover, na.action = na.omit)
mod2 <- lmer(data=alldata, Q10T ~ 1 + midDepth*landCover + (1|uniqueSite), na.action = na.omit)
mod3 <- lmer(data=alldata, Q10T ~ 1 + midDepth*landCover + (1|citationKey), na.action = na.omit)
mod4 <- lmer(data=alldata,Q10T ~ 1 + midDepth*landCover + (1|citationKey/uniqueSite), na.action = na.omit)
#Some predictor variables are on very different scales: consider rescaling (models 2-4)

AICc(mod, mod2, mod3, mod4)
#lowest AICc = mod4

summary(mod4)
anova(mod4)

#graphical exploration of residuals
F_Final <- fitted(mod4)
R_Final <- residuals(mod4, type = "pearson", scaled = TRUE) #type="response" 
#no difference in graphs with pearson vs response

N = !is.na(alldata$Q10)
Rfull <- NA
Rfull[N] <- R_Final

op <- par(mfrow = c(2,2), mar = c(5,4,1,1))
plot(F_Final, R_Final) #variance increases with value of Q10
hist(Rfull)
plot(Rfull ~ alldata$midDepth)
plot(Rfull ~ alldata$nitrogenPercent) #decrease in variance with N?
plot(Rfull ~ alldata$MAP)
boxplot(Rfull ~ alldata$landCover)
par(op)

```

#Environmental Characteristics (with carbon) Model
Need to change : to * so main effects and interactions included instead of just interactions
```{r}
print("number of data points with all variables (environmental model: midDepth, landCover, nitrogen, MAP)")
length(which(!is.na(alldata$midDepth) & !is.na(alldata$landCover) & !is.na(alldata$nitrogenPercent) & !is.na(alldata$MAP)))
print("number of data points with all variables AND %carbon")
length(which(!is.na(alldata$midDepth) & !is.na(alldata$landCover) & !is.na(alldata$nitrogenPercent) & !is.na(alldata$MAP) & !is.na(alldata$carbonPercent)))

#look for optimal random effects using transformed Q10 
#should carbon be included as carbon x depth? 
mod <- gls(data=alldata, Q10T ~ 1 + midDepth:landCover + carbonPercentAll:midDepth + nitrogenPercent:midDepth + MAP:midDepth, na.action = na.omit)
mod2 <- lmer(data=alldata, Q10T ~ 1 + midDepth:landCover + carbonPercentAll:midDepth + nitrogenPercent:midDepth + MAP:midDepth + (1|uniqueSite), na.action = na.omit)
mod3 <- lmer(data=alldata, Q10T ~ 1 + midDepth:landCover + carbonPercentAll:midDepth + nitrogenPercent:midDepth + MAP:midDepth + (1|citationKey), na.action = na.omit)
mod4 <- lmer(data=alldata,Q10T ~ 1 + midDepth:landCover + carbonPercentAll:midDepth + nitrogenPercent:midDepth + MAP:midDepth + (1|citationKey/uniqueSite), na.action = na.omit)
#Some predictor variables are on very different scales: consider rescaling (models 2-4)

AICc(mod, mod2, mod3, mod4)
#lowest AICc = mod4

summary(mod4)
anova(mod4)

#graphical exploration of residuals
F_Final <- fitted(mod4)
R_Final <- residuals(mod4, type = "pearson", scaled = TRUE) #type="response" 
#no difference in graphs with pearson vs response

N = !is.na(alldata$Q10)
Rfull <- NA
Rfull[N] <- R_Final

op <- par(mfrow = c(2,2), mar = c(5,4,1,1))
plot(F_Final, R_Final) #variance increases with value of Q10
hist(Rfull)
plot(Rfull ~ alldata$midDepth)
plot(Rfull ~ alldata$nitrogenPercent) #decrease in variance with N?
plot(Rfull ~ alldata$MAP)
par(op)

```

